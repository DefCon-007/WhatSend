<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Page Title</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">

    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.15/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.1.0/papaparse.js"
        integrity="sha256-iAuxnf8Cwr0yrQkpf6oQG4PaL/oVmoer6V/RfX2KQws=" crossorigin="anonymous"></script>
</head>

<body>

    <form class="" onsubmit="par();return false;">
        <div class="form-group">
            <label for="files">Upload a CSV formatted file:</label>
            <input type="file" id="files" class="form-control" accept=".csv" required>
        </div>
        <div class="form-group">
            <label for="nameselect">Selec column for name</label>
            <select id="nameselect">
            </select>
        </div>

        <div class="form-group">
            <label for="numberselect">Selec column for number</label>
            <select id="numberselect">
            </select>
        </div>

        <div class="form-group">
            <label for="message">Enter the message to send</label>
            <textarea id="message" class="form-control" required="" required> </textarea>
        </div>
        <div class="form-group">
            <input type="submit" id="submit-file" class="btn btn-primary" />
        </div>
    </form>

    <div id="parsed_csv_list"></div>

    <script>
        var csvData; null;
        function displayHTMLTable(results) {
            console.log("Disthe ljnfs")
            console.log(results['data'][0])
            debugger;
            var table = "<table class='table'>";
            var data = results.data;

            for (i = 0; i < data.length; i++) {
                table += "<tr>";
                var row = data[i];
                var cells = row.join(",").split(",");

                for (j = 0; j < cells.length; j++) {
                    table += "<td>";
                    table += cells[j];
                    table += "</th>";
                }
                table += "</tr>";
            }
            table += "</table>";
            elem = document.getElementById("parsed_csv_list");
            elem.innerHTML = table;
            // $("#").innerHTML = table;
        }

        function removeOptions(selectElement) {
            var i, L = selectElement.options.length - 1;
            for (i = L; i >= 0; i--) {
                selectElement.remove(i);
            }
        }

        function processParsedCSV(results) {
            console.log("Parsing")
            console.log(results)
            csvData = results['data'];
            const keys = _.keys(_.first(results['data']));
            console.log(keys);

            //Add options for the dropdown 
            var name_dropdown = document.getElementById("nameselect");
            var number_dropdown = document.getElementById("numberselect");
            removeOptions(name_dropdown);
            removeOptions(number_dropdown);

            console.log(name_dropdown)
            _.forEach(keys, key => {
                console.log(key);
                var opt = document.createElement("option");
                opt.text = key;
                opt.value = key;
                name_dropdown.options.add(opt.cloneNode(true));
                number_dropdown.options.add(opt);
            });


        }

        $('#files').change(function (event) {
            // File changed, parse it
            $('#files').parse({
                config: {

                    header: true,
                    complete: processParsedCSV,
                },
                before: function (file, inputElem) {
                    //console.log("Parsing file...", file);
                },
                error: function (err, file) {
                    Swal.fire({
                        icon: 'errir',
                        title: 'Unable to process file, please try with different file'
                    }
                    );
                },
                complete: function () {

                }
            });
        })

        function getCleanNumber(num) {
            matches = num.match(/\d+/g);
            var num_clean = ""
            _.forEach(matches, function (match) {
                num_clean += match
            })
            if (num_clean.length == 10) {
                num_clean = "91" + num_clean;
            }
            return num_clean;
        }
        function titleCase(str) {
            str = str.toLowerCase().split(' ');
            for (var i = 0; i < str.length; i++) {
                str[i] = str[i].charAt(0).toUpperCase() + str[i].slice(1);
            }
            return str.join(' ');
        }
        function getMessageToSend(message, name) {
            var newMessage = message;
            if (name) {
                newMessage = `Hi ${name},\n` + message
            } else {
                newMessage = `Hi,\n` + message
            }
            return newMessage;

        }

        var tabWindow = null;
        var urlsList = [];
        var timer = null;


        function openURLinWindow(url) {
            console.log(url);
            var win = window.open(url);
            return win
        }

        function polling() {
            console.log("waiting");
            console.log(urlsList)
            if (urlsList.length == 0) {
                console.log("no urls left")
                clearInterval(window.timer);
                return;
            }
            if (tabWindow && tabWindow.closed) {
                tabWindow = openURLinWindow(urlsList.pop())
            }
        }

        function par() {
            const numberCol = document.getElementById("numberselect").value;
            const nameCol = document.getElementById("nameselect").value;
            var messageStr = document.getElementById("message").value;
            _.forEach(csvData, function (data) {
                const clean_number = getCleanNumber(data[numberCol]);
                const name = titleCase(data[nameCol]);
                const clean_message = getMessageToSend(messageStr, name);
                var url = `https://web.whatsapp.com/send?phone=${clean_number}&text=${clean_message}`;
                urlsList.push(url);
            })
            tabWindow = openURLinWindow(urlsList.pop())
            console.log(urlsList);
            window.timer = setInterval('polling()', 1000);
        }

        console.log()




        console.log("It begins")


        // var win;
        // urls = ["https://web.whatsapp.com/send?phone=919098854207&text=message 1", "https://web.whatsapp.com/send?phone=919098854207&text=message 2", "https://web.whatsapp.com/send?phone=919098854207&text=message 3", "https://web.whatsapp.com/send?phone=919098854207&text=message 4", "https://web.whatsapp.com/send?phone=919098854207&text=message 5"]
        // win = openAndPush("https://web.whatsapp.com/send?phone=919098854207&text=base message", "")




        // 


    </script>



</body>

</html>