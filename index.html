<html>

<head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-5SPBL5R3CE"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-5SPBL5R3CE');
    </script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>WhatSend</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="57x57" href="./favicon/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="./favicon/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="./favicon/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="./favicon/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="./favicon/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="./favicon/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="./favicon/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="./favicon/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./favicon/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="./favicon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="./favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./favicon/favicon-16x16.png">
    <link rel="manifest" href="./favicon/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="theme-color" content="#ffffff">
    <meta name="msapplication-TileImage" content="./favicon/ms-icon-144x144.png">


    <!-- Primary Meta Tags -->
    <meta name="title" content="WhatSend - Send a message to multiple people on WhatsApp automatically">
    <meta name="description"
        content="Send messages in bulk to multiple people from a CSV file using just a web browser for free.  ">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://whatsend.defcon007.com/">
    <meta property="og:title" content="WhatSend - Send a message to multiple people on WhatsApp automatically">
    <meta property="og:description"
        content="Send messages in bulk to multiple people from a CSV file using just a web browser for free.  ">
    <meta property="og:image" content="./images/meta-tag-image.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://whatsend.defcon007.com/">
    <meta property="twitter:title" content="WhatSend - Send a message to multiple people on WhatsApp automatically">
    <meta property="twitter:description"
        content="Send messages in bulk to multiple people from a CSV file using just a web browser for free.  ">
    <meta property="twitter:image" content="./images/meta-tag-image.png">



    <!-- Latest compiled and minified Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <!-- Latest compiled JavaScript -->

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.15/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.1.0/papaparse.js"
        integrity="sha256-iAuxnf8Cwr0yrQkpf6oQG4PaL/oVmoer6V/RfX2KQws=" crossorigin="anonymous"></script>

        <!-- DataTable -->

    <link rel="stylesheet" type="text/css"
        href="https://cdn.datatables.net/v/dt/jszip-2.5.0/dt-1.10.21/b-1.6.3/b-flash-1.6.3/b-html5-1.6.3/b-print-1.6.3/r-2.2.5/datatables.min.css" />

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
    <script type="text/javascript"
        src="https://cdn.datatables.net/v/dt/jszip-2.5.0/dt-1.10.21/b-1.6.3/b-flash-1.6.3/b-html5-1.6.3/b-print-1.6.3/r-2.2.5/datatables.min.js"></script>
    <!-- Custom css file -->
    <link rel="stylesheet" type="text/css" href="./styles.css" />
</head>

<body style="background-color: #f1f1f1;">

    <nav>
        <a href="https://whatsend.defcon007.com"  class="logo">
            <img src="./images/logo.png" alt="logo" />
        </a>
        <ul class="menu">
            <li class="menu-item">
                <a href="#" class="nav-link active" style="color:#f8615a">Home</a>
            </li>
            <li class="menu-item">
                <a href="https://github.com/DefCon-007/WhatSend-extension/archive/master.zip" class="nav-link active" >Download Extension</a>
            </li>
            <li class="menu-item">
                <a href="#instructions" class="nav-link">Instructions</a>
            </li>
            <li class="menu-item">
                <a href="#input_form" class="nav-link">Send Messages</a>
            </li>
            <li class="menu-item">
                <a href="#result" class="nav-link">Result</a>
            </li>
            <li class="menu-item">
                <a href="#about" class="nav-link">About</a>
            </li>
            <li class="menu-item">
                <a href="#lab_social_icon_footer" class="nav-link">Contact</a>
            </li>
        </ul>
    </nav>
    <div class="main">

        <!-- <div style="padding-left: 10%;padding-right: 10%;padding-top: 5%;"> -->

        <section id="about" align="center">
            <h2>What is it?</h2>
                <hr style="margin-left: 15%;margin-right: 15%;">
            <iframe width="560" height="315" src="https://www.youtube.com/embed/tz088WQSjGw" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </section>
    
        <section id="input_form">

            <form style="padding-left: 10%;padding-right: 10%" onsubmit="formSubmit();return false;">
                <h2>Specifications</h2>
                Configure the sender
                <hr>
                <div class="form-group">
                    <label for="files">Upload a CSV file:</label><br>
                    <span><i class="fa fa-info-circle"></i></span> The CSV file should have at least two columns, one for name and one for numbers.<br> The numbers should either be in international format (91 appended for India, 1 for US. If not found, India country code will be automatically appended)
                    <input type="file" id="files" class="form-control" accept=".csv" required>
                </div>
                <div class="form-group">
                    <label for="nameselect">Select column for name</label>
                    <select id="nameselect">
                    </select>
                </div>

                <div class="form-group">
                    <label for="numberselect">Select column for number</label>
                    <select id="numberselect">
                    </select>
                </div>

                <div class="form-group">
                    <label for="customCol1">Select column for custom data</label>
                    <select id="customCol1">
                    </select>
                    <input id="customCol1_id" type="text" />
                </div>

                <div class="form-group">
                    <label for="customCol2">Select column for custom data</label>
                    <select id="customCol2">
                    </select>
                    <input id="customCol2_id" type="text" />
                </div>

                <div class="form-group">
                    <label for="message">Enter the message to send</label>
                    <textarea id="message" class="form-control" required> </textarea>
                </div>
                <div class="form-group">
                    <input type="submit" id="submit-file" class="btn btn-primary" />
                </div>
                <hr>
            </form>
        </section>

        <section id="result">
            <div style="padding-left: 10%;padding-right: 10%;margin-top: 1%;">
            <h3 >Processed numbers</h3>
            As soon as you start sending messages this table will get filled with the numbers to which the message has been sent. 
        </div>
            <br>
            <div class="container">
                <table class="table table-striped table-bordered" id="table-id">
                    <thead>
                        <tr>
                            <th>Id</th>
                            <th>Name</th>
                            <th>Number</th>
                            <th data-type="@data-sort">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                    <tbody>
                </table>

            </div>
        </section>
        <section id='instructions'>
            <h3>Important instructions</h3>

            Follow the below instructions to get started<br>

            <ol class="list-group list-group-flush">
                <li class="list-group-item">
                    <span class="badge badge-pill badge-danger">Important</span>
                    Make sure the all the popups are allowed for <span>
                        <u>https://whatsend.defcon007.com</u>
                    </span>. If you don't know how to do it, follow the steps mentioned <a
                        href="https://github.com/DefCon-007/WhatSend/wiki/Allow-popups-in-chrome"
                        target="_blank">here</a>.
                </li>

                <li class="list-group-item"><span class="badge badge-pill badge-danger">Important</span>
                    Make sure you can access WhatsApp web in the current browser.
                    <details>
                        <summary>Click here to know how to do it.</summary>

                        <ul>
                            <li>
                                Open WhatsApp web in a new tab by clicking <a href="https://web.whatsapp.com"
                                    target="_blank">here</a>.
                            </li>
                            <li>
                                Log in with the account you wish to send message from, if not already logged in.
                            </li>
                            <li>
                                If you are logged in at other places too, you will see option to use WhatsApp web
                                here.
                                Click `Use here` option.
                            </li>
                            <li>
                                Close the tab.
                            </li>
                        </ul>
                    </details>
                </li>
                <li class="list-group-item">Download the helper chrome extension from <a target="_blank"
                        href="https://github.com/DefCon-007/WhatSend-extension/archive/master.zip">here</a> and load
                    it
                    in the browser by following the instructions from <a target="_blank"
                        href="https://github.com/DefCon-007/WhatSend-extension/wiki/Installation">here</a>.
                </li>
                <li class="list-group-item">
                    You are good to go now. Just select the corresponding CSV file and then select the columns for
                    name
                    and mobile number, whatever message you type in the box below, value from name columns will
                    automatically be appended to it.<br><br> i.e. if the message is, <span style="color:grey">This
                        is a
                        message</span>, following text will be sent to user whose name is UserName,<br><span
                        style="color: #68d10d;">Hi
                        Username, This is a
                        message</span><br>If name is not found in a row, the message will be as follows:<br>
                    <span style="color: #68d10d;">Hi, This is a
                        message</span>
                </li>
            </ol>

        </section>
        <!-- </div> -->
        <section id="lab_social_icon_footer">
            <div class="container">
                <div class="text-center center-block">
                    <a href="https://github.com/DefCon-007" target="_blank"><i id="social-fb"
                            class="fa fa-github fa-3x social"></i></a>
                    <a href="https://twitter.com/@defcon_007" target="_blank"><i id="social-tw"
                            class="fa fa-twitter fa-3x social"></i></a>
                    <a href="https://defcon007.com" target="_blank"><i id="social-gp"
                            class="fa fa-globe fa-3x social"></i></a>
                    <a href="mailto:ayushgoyal.iitkgp@gmail.com" target="_blank"><i id="social-em"
                            class="fa fa-envelope-square fa-3x social"></i></a>
                </div>
                <br>
                <p class="footer-heart">
                    Made with <g-emoji class="g-emoji" alias="heart"
                        fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/2764.png">
                        <img class="emoji" alt="heart" height="20" width="20"
                            src="https://github.githubassets.com/images/icons/emoji/unicode/2764.png"></g-emoji> by <a
                        href="https://defcon007.com" target="_blank">Ayush</a>
                </p>
            </div>
        </section>
    </div>
    <script>
        var csvData; null;
        var table_element = null;

        $.fn.dataTable.ext.order['dom-image-check'] = function (settings, col) {
            return this.api().column(col, { order: 'index' }).nodes().map(function (td, i) {
                if (td.getAttribute('data-sort') === "success") {
                    return '1'
                } else {
                    return '0'
                }
            });
        }

        $(document).ready(function () {
            table_element = $('#table-id').DataTable({
                dom: 'Bfrtip',
                buttons: [
                    'copy', 'csv', 'excel', 'pdf', 'print'
                ],
                "columns": [
                    null,
                    null,
                    null,
                    { "orderDataType": "dom-image-check" },
                ]
            });
        });
        function removeOptions(selectElement) {
            var i, L = selectElement.options.length - 1;
            for (i = L; i >= 0; i--) {
                selectElement.remove(i);
            }
        }

        function processParsedCSV(results) {
            csvData = results['data'];
            const keys = _.keys(_.first(results['data']));

            //Add options for the dropdown 
            var name_dropdown = document.getElementById("nameselect");
            var number_dropdown = document.getElementById("numberselect");
            var all_dropdowns = []

            for (var counter=1; counter<=2; counter++){
                var dropdown_element = document.getElementById(`customCol${counter}`)

                if (dropdown_element){
                    all_dropdowns.push(dropdown_element)
                    removeOptions(dropdown_element)
                }else {
                    break;
                }

            }

            removeOptions(name_dropdown);
            removeOptions(number_dropdown);
            var all_options = []
            _.forEach(keys, key => {
                // Add dropdown options of table columns
                var opt = document.createElement("option");
                opt.text = key;
                opt.value = key;
                name_dropdown.options.add(opt.cloneNode(true));
                number_dropdown.options.add(opt);
                all_options.push(opt)
            });


            // Add select options for all dropdowns
            _.forEach(all_dropdowns, dropdown => {
                _.forEach(all_options, option => {
                   dropdown.options.add(option.cloneNode(true)); 
                }) 
            })
        }

        $('#files').change(function (event) {
            // File changed, parse it
            $('#files').parse({
                config: {
                    header: true,
                    complete: processParsedCSV,
                },
                before: function (file, inputElem) {
                },
                error: function (err, file) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Unable to process file, please try with different file'
                    }
                    );
                },
                complete: function () {

                }
            });
        })

        function getCleanNumber(num) {
            matches = num.match(/\d+/g);
            var num_clean = ""
            _.forEach(matches, function (match) {
                num_clean += match
            })
            if (num_clean.length == 10) {
                num_clean = "91" + num_clean;
            }
            return num_clean;
        }

        function titleCase(str) {
            str = str.toLowerCase().split(' ');
            for (var i = 0; i < str.length; i++) {
                str[i] = str[i].charAt(0).toUpperCase() + str[i].slice(1);
            }
            return str.join(' ');
        }

        function getMessageToSend(message, name, csvData) {
            var newMessage = message;
            if (name) {
                newMessage = `Hi ${name},\n` + message
            } else {
                newMessage = `Hi,\n` + message
            }

            // Replace other values
            if (csvData){
                for (var counter = 1; counter <= 2; counter++) {
                    var text_to_replace = document.getElementById(`customCol${counter}_id`).value
                    var columnName = document.getElementById(`customCol${counter}`).value;
                    newMessage = _.replace(newMessage, text_to_replace, csvData[columnName]);
                }
            }
            

            return newMessage;

        }

        var urlsList = [];
        var timer = null;
        window.tabWindows = false;

        function openURLinWindow(item) {
            var win = window.open(item['url'], "com_defcon007_whatsSend");
            addToProcessedTable(item);
            return win;
        }

        function addToProcessedTable(item) {
            var row_node = table_element.row.add([
                item['index'],
                item['name'],
                item['number'],
                ' ',
            ]).draw(false).node();
            var tds = row_node.getElementsByTagName("td");
            tds[3].setAttribute('data', item['number']);
            tds[3].setAttribute('data-type', 'status');
        }

        async function polling() {
            if (urlsList.length == 0) {
                // Make status of all empty as warning now! 
                var elems = document.querySelectorAll("td[data-type='status']")
                for (var i = 0; i < elems.length; i++) {
                    elem = elems[i];
                    if (!(elem.innerHTML.toString().trim())) {
                        // No status added right now add one
                        elem.innerHTML = "<img src='https://raw.githubusercontent.com/DefCon-007/WhatSend/master/images/Warning.svg?sanitize=true' />"
                    }
                }
                Swal.fire({
                    icon: 'success',
                    title: 'All messages sent!'
                }
                );
                clearInterval(window.timer);
                clearTimeout();
                return;
            }
            if (window.tabWindow && window.tabWindow.closed) {
                window.tabWindow = openURLinWindow(urlsList.pop())
            }
        }

        function formSubmit() {
            var messageStr = document.getElementById("message").value;
            var msg = getMessageToSend(messageStr, "NAME", null);
            console.log(msg);
            Swal.fire({
                title: 'Following message will be sent to numbers in the file.',
                html: msg,
                icon: 'info',
                showCancelButton: true,
                confirmButtonColor: '#25cf19',
                cancelButtonColor: '#db1818',
                confirmButtonText: 'Yes, send it!'
            }).then((result) => {
                if (result.value) {
                    parseFormData();
                }
            })
        }

        function parseFormData() {
            const numberCol = document.getElementById("numberselect").value;
            const nameCol = document.getElementById("nameselect").value;
            var messageStr = document.getElementById("message").value;

            _.forEach(csvData, function (data, index) {
                if (!(data[numberCol])) {
                    return;
                }
                console.log(data)
                const clean_number = getCleanNumber(data[numberCol]);
                const name = titleCase(data[nameCol]);
                const clean_message = getMessageToSend(messageStr, name, data);
                var url = `https://web.whatsapp.com/send?phone=${clean_number}&text=${clean_message}`;
                urlsList.push({
                    url: url,
                    name: name,
                    index: csvData.length - index,
                    number: clean_number
                });
            })
            window.tabWindow = openURLinWindow(urlsList.pop())
            window.timer = setInterval('polling()', 1000);
        }

        window.addEventListener("message", function (event) {
            // We only accept messages from ourselves
            console.log("Listeninf mesg from webspage");
            console.log(event)
            if (event.source != window)
                return;

            if (event.data.type && (event.data.type == "FROM_PAGE")) {
                console.log("Content script received message: " + event.data.text);
            }
        });
    </script>

</body>

</html>